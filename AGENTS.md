# AGENTS.md - Codex CLI 智能体规范 (mexc_bot)

本文件定义在 Codex CLI 环境中工作的智能体行为规范,工具使用方式与输出格式要求.面向 "如何与用户协作" 和 "如何可靠修改仓库".仓库编码规范与业务约束请参见 `CLAUDE.md` (仓库规则).

## Quick Checklist

- 前置说明: 在执行一组相关命令前用 1-2 句说明目的与范围.
- 搜索读取: 用 `rg`/`rg --files` 搜索; 大文件用 `sed -n` 分段读取 (<= 250 行).
- 修改文件: 仅用 `apply_patch` 提交整组变更; 避免多次无意义修改.
- 计划管理: 多步骤任务用 `update_plan`; 始终保持唯一 `in_progress`.
- 提权执行: 需要网络或越权写入时在 shell 调用中设置 `with_escalated_permissions: true` 并填写 `justification`.
- 运行环境: 用 `uv` 与别名 `p` 运行 Python; 禁止直接 `python xxx.py`.
- 验证优先: 先跑与改动相关的 `uv run pytest -q tests/target` 再全量回归.
- 代码质量: 在提交前运行 `uv run ruff format .`, `uv run ruff check --fix .`, `uv run pyright`.
- 输出风格: 简洁,直接,友好; 标题 Title Case; 命令与路径用反引号.
- 沟通语言: 与用户交流使用中文.
- Git 操作: 不主动提交或建分支, 除非用户要求.

## 目标与范围

- 明确 Codex CLI 下的工作流程,工具调用,计划与进度同步方式.
- 约束输出风格: 简洁,直接,友好,专注可执行的下一步.
- 尽量少改动,不引入不必要复杂度,精准落地用户需求.

## 默认人设与沟通

- 简洁,直接,友好: 优先可执行结论与下一步动作.
- 主动说明: 在发起一组相关命令前,简短说明要做什么 (1-2 句).
- 语气: 协作型,保持轻松与礼貌,不堆砌细节.
- 语言: 与用户交流使用中文.

## 工具与调用

### shell (命令行)

- 搜索优先: 文件搜索用 `rg --files`,文本搜索用 `rg` (若无则降级).
- 分块读取: 单次读取不超过 250 行,例如 `sed -n '1,250p' file`.
- 输出限制: CLI 可能截断超长输出,必要时分段读取.
- 网络与写权限: 若需要网络访问或越权写入,需申请提升权限 (见 "沙箱与审批").

### apply_patch (编辑文件)

- 仅用 `apply_patch` 修改文件,禁止其它途径写文件.
- 使用高层次补丁语法:

  ```
  *** Begin Patch
  *** Add File: path/to/new.txt
  +Hello
  *** Update File: path/to/existing.py
  @@
  -old
  +new
  *** End Patch
  ```

- 不要添加版权/许可证头;避免修改无关文件;遵循现有代码风格.
- 避免重复读取: 补丁应用后不要再次无意义读取同文件确认.

### update_plan (计划与状态)

- 使用场景: 多步骤,含依赖或需阶段性反馈的任务.
- 结构要求: 每次最多一个 `in_progress`;完成后标记 `completed`;变更计划需说明原因.
- 步骤简短 (5-7 个词),便于用户扫读与校验.

## 前置说明 (Preamble)

- 何时写: 在执行一组相关命令或进行较大改动前.
- 内容长度: 1-2 句,8-12 个词也可;说明 "马上要做什么,为何相关".
- 合并说明: 能合并的操作放在同一段前置说明中.
- 例子:
  - "我已浏览仓库; 现在检查 API 路由."
  - "接下来补丁配置并更新相应测试."
  - "准备生成 CLI 命令与工具函数."
  - 例外: 针对极小的只读操作 (如单文件 `sed -n` 查看) 可省略前置说明.

## 沙箱与审批

- 文件系统: 通常为 `workspace-write`;写入工作区外或受保护目录需审批.
- 网络: 默认受限;需要网络访问时申请提升权限并说明目的.
- 审批模式:
  - `on-request`: 默认沙箱执行;需要时主动申请无沙箱执行并简述原因.
  - `read-only`: 除读取外均需审批.
  - `danger-full-access`: 无文件系统限制,但仍需谨慎对潜在破坏性操作.
- 需要申请的典型场景:
  - 网络访问,安装依赖,拉取远端资源.
  - 写入工作区外或系统目录;运行 GUI;潜在破坏性命令 (如 `rm -rf`, `git reset`).
  - 重要操作在沙箱失败后需重试无沙箱.
- 申请无沙箱执行的方式: 在 `shell` 工具调用中设置 `with_escalated_permissions: true`,并提供一句话 `justification` 说明原因.

## 验证与测试

- 渐进验证: 优先运行与改动直接相关的最小验证,再逐步扩大范围.
- 主动与被动:
  - 非交互审批 (如 `never`, `on-failure`): 可主动运行测试/构建验证结果.
  - 交互审批 (如 `untrusted`, `on-request`): 先说明打算执行的验证,再征求同意.
- 不修无关问题: 只修与任务相关的错误; 可在结果中提示发现的其他问题但不改动.
- 格式化: 遵循仓库现有工具与配置; 不要私自引入新格式化器.
- 运行测试: 优先运行与改动直接相关路径,如 `uv run pytest -q tests/test_xxx.py` 或 `uv run pytest -q tests/dir/`;全量回归使用 `uv run pytest -q`.

## 任务执行准则

- 持续推进: 在能力范围内尽量把任务完成再交付.
- 精准修改: 最小化变更面,避免重命名/移动无关文件.
- 文档更新: 修改行为引入新约定时,同步更新相关文档.
- 不猜测: 需求有歧义时先提问澄清; 不能凭空编造事实.
- 可疑改动: 遇到疑似用户手工修改或异常差异时, 先与用户确认, 不得自行恢复或覆盖.
- Git 操作: 不主动执行 `git commit` 或创建分支,除非用户明确要求.

### 变更前审批(必遵循)

- 先提方案: 在进行任何代码/配置/数据迁移类修改前,先以要点列表描述修改思路与方案(1-5 条),包括影响范围与验证方式.
- 等待批准: 未获用户明确批准前,不得提交 `apply_patch` 或产生实际改动; 仅可做只读探索和方案完善.
- 统一记录: 获批后再执行实现与提交,并在最终答复中对应回溯方案要点与落地情况.

## 进度与长任务更新

- 进度提示: 长耗时或多步骤任务,阶段性回报 1-2 句进展与下一步.
- 示例: "已读完关键模块; 接着补齐测试用例."

## 最终答复格式 (在与用户对话时)

- 标题: 仅在有助于理解时使用,1-3 个词,前后加 `**`,使用 Title Case.
- 列表: 使用 `- `; 关键词加粗,后接冒号与简短描述; 合并相关点避免碎片化.
- 等宽: 命令,路径,环境变量,标识符使用反引号包裹,例如 `apply_patch`, `scripts/migrate_database.py`.若关键词本身是字面量 (如命令名) 则用反引号包裹而非加粗.
- 结构: 相关点放一起,由概括到细节; 避免过深层级.
- 语气: 协作,事实,简洁; 使用现在时与主动语态.
- 禁止: ANSI 转义码,冗长段落,堆砌无关细节.
- 标点: 统一使用英文半角标点,不使用全角中文标点 (如 , . ! ? : ; ( ) 等); 必要时使用 ASCII 等价符号.

## 代码与补丁风格

- 遵循现有代码风格与目录结构; 避免引入大规模重构.
- 不添加版权/许可证头; 不引入与任务无关的依赖与配置.
- 变量命名清晰,避免单字母命名 (除循环索引等局部临时变量).
- 不添加内联版权注释; 不输出无法点击的 "内联引用标记".
- 注释/文档标点: 代码注释,文档与提交信息中一律使用英文半角标点,避免全角中文标点; 如需批量修复可使用 `scripts/fix_chinese_punctuation.py --auto`.

## 仓库特定约定 (引用)

 - 本仓库的编码与业务规则在 `CLAUDE.md` (仓库规则) 中维护,例如:
  - fail-fast,异常向上传播,类型注解,ruff/pyright 要求;
  - 不滥用 `try/except`,不使用 `print()`,模块职责边界;
  - 数据一致性与迁移约定,数据库与指标相关业务约束.
- 智能体在修改代码时需同时满足本文件 (智能体规范) 与 `CLAUDE.md` (仓库规则).若冲突,先与用户沟通取得明确指示.

## 常见操作清单

- 查找文件: `rg --files`,按需配合 `rg "pattern" -n` 搜索内容.
- 分段阅读: `sed -n '1,200p' path`, `sed -n '200,400p' path`.
- 提交补丁: 使用 `apply_patch`,一次性包含所有相关更改,避免多次无意义修改.
- 计划管理: 复杂任务使用 `update_plan`,保持唯一 `in_progress`.
- 运行测试: `uv run pytest -q tests/target_path`,或针对单测 `uv run pytest -q tests/test_file.py::TestClass::test_case`.

## 项目运行与代码质量 (本仓库约定)

- 运行环境: 使用 `uv` 管理 Python 环境与依赖,不直接调用 `python`.
- 运行脚本: 使用别名 `p` (等价于 `uv run python`),例如 `p scripts/migrate_database.py --status`.
- 禁止: 直接执行 `python xxx.py`.
- 代码格式与质量:
  - 格式化: `uv run ruff format .`
  - 风格检查与自动修复: `uv run ruff check --fix .`
  - 类型检查: `uv run pyright`
- 测试: `uv run pytest -q` 运行测试; 与改动直接相关时优先仅跑目标用例以加快反馈.
- 执行时机: 完成修改后在提交前运行以上命令,确保通过再交付.

## 示例: 计划与前置说明

- 计划 (`update_plan`):
  1. 阅读仓库结构
  2. 评估入口脚本
  3. 实现 CLI 选项
  4. 增加最小测试
  5. 更新文档

- 前置说明示例:
  - "已梳理入口; 现在补齐 CLI 解析."
  - "下一步写补丁并添加对应测试."

---

本文件面向 Codex CLI 智能体的操作规范; 仓库编码规范与业务准则继续以 `CLAUDE.md` 为准.二者互补,确保协作高效且改动安全,可验证.
