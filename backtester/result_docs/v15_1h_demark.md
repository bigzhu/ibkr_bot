# v15_1h_demark

## 需求

每次 BUY 的时候, 固定对 30m 的时间周期进行检测, 限定只有30m 的 demark 信号方向是 SELL 的时候, 才允许 BUY, 否则抛出异常终止 BUY 动作

设定一个常量开关, 放在 feature_flags.py, 开启才进行该检查

## 实现方案

1. 在 `order_builder/feature_flags.py` 新增 `THIRTY_MIN_DEMARK_GUARD_ENABLED` 开关, 默认关闭.
2. 新增 `order_builder/demark_guard.py`, 提供 `ensure_thirty_min_demark_allows_buy`:
   - 开关关闭时直接返回.
   - 通过 `demark_with_ibkr_api(symbol, "30m")` 获取 30m demark 信号.
   - 当信号方向不是 `SELL` 时抛出 `ValueError`, 阻止 BUY.
3. 在 BUY 流程中 (数量计算前) 调用守护函数, 与现有 RSI 守护并列, 只影响 BUY.
4. 为守护函数补充单元测试, 覆盖 SELL 放行与其他方向阻断两个分支.

## 回测

### BUY_FROM_COMPARE_KLINES=True

5557.152170

| Month   | Transactions | Gross Revenue | Fees    | Net Revenue |
| ------- | ------------ | ------------- | ------- | ----------- |
| 2025-09 | 253          | $19.42        | $4.77   | $14.66      |
| 2025-08 | 2014         | $235.01       | $53.45  | $181.56     |
| 2025-07 | 1843         | $203.38       | $47.26  | $156.13     |
| 2025-06 | 1114         | $91.13        | $21.00  | $70.13      |
| 2025-05 | 1745         | $176.78       | $42.97  | $133.81     |
| 2025-04 | 1476         | $176.87       | $34.19  | $142.67     |
| 2025-03 | 2310         | $696.52       | $83.94  | $612.58     |
| 2025-02 | 2453         | $372.48       | $69.50  | $302.99     |
| 2025-01 | 3194         | $409.22       | $95.97  | $313.25     |
| 2024-12 | 3591         | $651.00       | $133.45 | $517.55     |
| 2024-11 | 3823         | $859.95       | $176.54 | $683.41     |
| 2024-10 | 830          | $71.97        | $15.99  | $55.98      |
| 2024-09 | 817          | $68.59        | $14.80  | $53.79      |
| 2024-08 | 1212         | $150.67       | $27.06  | $123.62     |
| 2024-07 | 1257         | $121.69       | $27.08  | $94.61      |
| 2024-06 | 813          | $81.50        | $17.51  | $63.99      |
| 2024-05 | 1151         | $101.29       | $23.82  | $77.47      |
| 2024-04 | 2188         | $264.20       | $58.93  | $205.27     |
| 2024-03 | 3820         | $482.24       | $123.25 | $358.99     |
| 2024-02 | 2612         | $249.72       | $72.12  | $177.60     |
| 2024-01 | 1883         | $483.77       | $80.11  | $403.67     |

最终收益是 $4743.73

手续费 $1223.71

占住资金减少 1000 收益也减少了 1000

### 5m

3117.599170

| Month   | Transactions | Gross Revenue | Fees   | Net Revenue |
| ------- | ------------ | ------------- | ------ | ----------- |
| 2025-09 | 133          | $8.45         | $2.05  | $6.39       |
| 2025-08 | 1074         | $105.99       | $23.56 | $82.43      |
| 2025-07 | 969          | $90.43        | $20.01 | $70.42      |
| 2025-06 | 578          | $40.94        | $8.65  | $32.29      |
| 2025-05 | 975          | $81.42        | $18.93 | $62.49      |
| 2025-04 | 826          | $83.02        | $15.81 | $67.21      |
| 2025-03 | 1238         | $382.58       | $37.67 | $344.91     |
| 2025-02 | 1275         | $154.22       | $30.78 | $123.44     |
| 2025-01 | 1705         | $194.06       | $43.93 | $150.13     |
| 2024-12 | 1867         | $317.43       | $59.11 | $258.32     |
| 2024-11 | 2178         | $435.30       | $86.63 | $348.67     |
| 2024-10 | 461          | $32.39        | $6.82  | $25.57      |
| 2024-09 | 419          | $30.07        | $6.05  | $24.03      |
| 2024-08 | 607          | $57.68        | $10.83 | $46.85      |
| 2024-07 | 701          | $51.29        | $11.29 | $40.00      |
| 2024-06 | 451          | $41.55        | $8.32  | $33.23      |
| 2024-05 | 603          | $44.53        | $10.16 | $34.37      |
| 2024-04 | 1198         | $113.06       | $25.58 | $87.48      |
| 2024-03 | 2033         | $217.86       | $53.92 | $163.94     |
| 2024-02 | 1481         | $123.59       | $35.74 | $87.85      |
| 2024-01 | 965          | $336.64       | $36.48 | $300.16     |

    21737

$2942.50
$552.31
$2390.19

### 3m

2147.617320 USDC (之前: 2111.613200), 本地时间: 2024-07-05 14:56:00 CST

| Month   | Transactions | Gross Revenue | Fees   | Net Revenue |
| ------- | ------------ | ------------- | ------ | ----------- |
| 2024-06 | 452          | $27.72        | $6.13  | $21.59      |
| 2024-05 | 575          | $40.28        | $9.11  | $31.17      |
| 2024-04 | 1120         | $91.52        | $21.33 | $70.18      |
| 2024-03 | 1925         | $165.66       | $45.76 | $119.89     |
| 2024-02 | 1409         | $102.56       | $29.07 | $73.49      |
| 2024-01 | 1019         | $362.12       | $38.94 | $323.18     |

占用资金大, 每月收入还比 5m 的少. 我都不想测试完毕了

### 15m

3272.394410

1m 新最大值: 3272.394410 USDC (之前: 3265.413900), 本地时间: 2025-06-23 05:34:00 CST

| Month   | Transactions | Gross Revenue | Fees    | Net Revenue |
| ------- | ------------ | ------------- | ------- | ----------- |
| 2025-09 | 141          | $10.26        | $2.44   | $7.83       |
| 2025-08 | 1176         | $139.98       | $30.40  | $109.57     |
| 2025-07 | 1094         | $113.62       | $25.60  | $88.03      |
| 2025-06 | 632          | $50.98        | $11.03  | $39.95      |
| 2025-05 | 1022         | $97.38        | $23.39  | $73.98      |
| 2025-04 | 858          | $93.59        | $18.22  | $75.37      |
| 2025-03 | 1314         | $427.17       | $45.40  | $381.77     |
| 2025-02 | 1310         | $175.70       | $34.43  | $141.27     |
| 2025-01 | 1814         | $225.67       | $52.69  | $172.98     |
| 2024-12 | 1953         | $288.78       | $67.84  | $220.94     |
| 2024-11 | 2322         | $505.43       | $103.46 | $401.97     |
| 2024-10 | 425          | $31.61        | $6.84   | $24.77      |
| 2024-09 | 448          | $37.03        | $7.35   | $29.68      |
| 2024-08 | 641          | $65.02        | $12.20  | $52.82      |
| 2024-07 | 703          | $59.05        | $12.80  | $46.25      |
| 2024-06 | 489          | $37.99        | $8.31   | $29.68      |
| 2024-05 | 645          | $56.04        | $12.50  | $43.54      |
| 2024-04 | 1167         | $106.66       | $26.70  | $79.95      |
| 2024-03 | 2201         | $223.39       | $62.80  | $160.59     |
| 2024-02 | 1596         | $140.01       | $40.66  | $99.35      |
| 2024-01 | 1069         | $187.27       | $40.80  | $146.47     |

    23020

$3072.64
$645.86
$2426.78

### 30m

1m 新最大值: 3403.365220 USDC (之前: 3394.999270), 本地时间: 2025-06-23 05:29:00 CST

| Month   | Transactions | Gross Revenue | Fees    | Net Revenue |
| ------- | ------------ | ------------- | ------- | ----------- |
| 2025-09 | 148          | $11.02        | $2.72   | $8.30       |
| 2025-08 | 1214         | $137.72       | $30.95  | $106.77     |
| 2025-07 | 1087         | $117.23       | $26.53  | $90.70      |
| 2025-06 | 658          | $50.89        | $11.53  | $39.36      |
| 2025-05 | 1068         | $105.24       | $25.40  | $79.84      |
| 2025-04 | 835          | $90.94        | $17.75  | $73.18      |
| 2025-03 | 1323         | $442.08       | $47.12  | $394.96     |
| 2025-02 | 1347         | $170.77       | $34.94  | $135.83     |
| 2025-01 | 1793         | $218.60       | $52.08  | $166.52     |
| 2024-12 | 1904         | $286.50       | $67.09  | $219.42     |
| 2024-11 | 2387         | $542.84       | $113.04 | $429.80     |
| 2024-10 | 438          | $37.47        | $7.87   | $29.59      |
| 2024-09 | 496          | $39.97        | $8.28   | $31.69      |
| 2024-08 | 656          | $61.59        | $12.20  | $49.39      |
| 2024-07 | 759          | $65.64        | $14.42  | $51.22      |
| 2024-06 | 449          | $36.01        | $7.90   | $28.11      |
| 2024-05 | 657          | $55.91        | $12.66  | $43.24      |
| 2024-04 | 1165         | $121.37       | $28.54  | $92.84      |
| 2024-03 | 2102         | $227.35       | $62.63  | $164.73     |
| 2024-02 | 1686         | $146.81       | $43.49  | $103.32     |
| 2024-01 | 1057         | $187.23       | $40.74  | $146.49     |

    23229

$3153.18
$667.87
$2485.31

### 3m 30m

3m 新最大值: 3638.206500 USDC (之前: 3629.230960), 本地时间: 2025-07-02 05:09:00 CST

| Month   | Transactions | Gross Revenue | Fees   | Net Revenue |
| ------- | ------------ | ------------- | ------ | ----------- |
| 2025-09 | 93           | $10.38        | $2.09  | $8.30       |
| 2025-08 | 665          | $124.56       | $22.23 | $102.33     |
| 2025-07 | 601          | $100.31       | $19.18 | $81.13      |
| 2025-06 | 394          | $41.75        | $8.27  | $33.48      |
| 2025-05 | 602          | $89.92        | $18.54 | $71.38      |
| 2025-04 | 496          | $85.73        | $13.59 | $72.13      |
| 2025-03 | 663          | $398.50       | $29.84 | $368.66     |
| 2025-02 | 665          | $151.04       | $24.51 | $126.53     |
| 2025-01 | 875          | $200.73       | $38.15 | $162.58     |
| 2024-12 | 905          | $225.89       | $44.54 | $181.35     |
| 2024-11 | 1081         | $476.79       | $71.25 | $405.53     |
| 2024-10 | 318          | $34.81        | $6.66  | $28.15      |
| 2024-09 | 340          | $37.86        | $6.83  | $31.03      |
| 2024-08 | 375          | $48.10        | $8.73  | $39.37      |
| 2024-07 | 490          | $58.41        | $11.43 | $46.99      |
| 2024-06 | 317          | $33.85        | $6.55  | $27.30      |
| 2024-05 | 397          | $49.09        | $9.64  | $39.45      |
| 2024-04 | 671          | $114.52       | $21.34 | $93.18      |
| 2024-03 | 1052         | $194.30       | $43.73 | $150.57     |
| 2024-02 | 1005         | $138.96       | $34.90 | $104.06     |
| 2024-01 | 781          | $174.67       | $34.65 | $140.02     |

    12786

$2790.18
$476.67
$2313.51
