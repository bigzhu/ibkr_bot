# v11

## 需求

1. 去掉 SELL 每超过 1 demark 信号就减少 0.1% 盈利要求的功能
2. 当 demark 信号大于等于配置的 symbol_timeframe_configs.demark_sell 的时候, 可以进入挂单流程

挂单流程判断规则:

SELL 直接使用最新一根 K 线(`demark_klines[-1]`) 的 `low`, 只要相对基准价的涨幅达到配置项 `symbol_timeframe_configs.minimum_profit_percentage` 即可挂单.

BUY 改为"及时入场", 只要最新一根 K 线的 `high` 相对基准价出现下跌即可挂单.
账户余额查询会自动合并 Binance 返回的 `LD` 前缀资产, 并在现货余额不足时自动赎回对应的活期理财份额后再尝试下单; BUY 场景下若赎回后仍不足, 会使用现有计价资产调整下单数量, 避免完全无法下单.

## 需求澄清

- SELL 挂单价使用最新 K 线 `low`, 并以 `symbol_timeframe_configs.minimum_profit_percentage` 作为唯一阈值.
- DeMark 序列索引从 0 开始, `demark_klines[0]` 表示 DeMark 1.
- BUY 采用及时入场策略, 只需最新 K 线 `high` 相对基准价出现下跌.
- "进入挂单流程"的判断在数量计算阶段执行, 不满足条件时抛业务错误以阻止后续流程.
- 已有挂单比较针对同交易对且同时间周期的唯一 SELL 挂单, 若新价格小于等于该挂单则跳过下单; 现有程序逻辑可复用.
- 仅对 SELL 停用原有"Demark 每增加 1 减少 0.1%"的逻辑, BUY 维持现状.

### 自动赎回与余额策略

- BUY 挂单前会预估所需计价货币, 优先检查现货余额; 若不足则通过 `redeem_simple_earn_flexible_product` 自动赎回活期理财, 赎回成功后再执行挂单.只有在赎回后仍余额不足时, 才进入原有的"取消旧单再重试"流程.
- 余额查询统一返回现货/资金/活期理财的合计, Binance 返回的 `LD` 资产会映射回原币种, 避免页面展示和业务逻辑出现余额缺失.
- 提供 CLI 工具用于手动测试活期赎回:
  - 赎回指定数量: `uv run python ibkr_api/simple_earn_redeem.py USDC 100`
  - 赎回全部: `uv run python ibkr_api/simple_earn_redeem.py USDC --all`

## 测试

### demark 4

3b0ebc9b

6462.838170

| Month   | Transactions | Gross Revenue | Fees    | Net Revenue |
| ------- | ------------ | ------------- | ------- | ----------- |
| 2025-08 | 474          | $256.52       | $54.21  | $202.31     |
| 2025-07 | 528          | $229.26       | $56.26  | $173.00     |
| 2025-06 | 326          | $106.51       | $30.88  | $75.62      |
| 2025-05 | 509          | $204.04       | $54.14  | $149.90     |
| 2025-04 | 449          | $208.23       | $45.80  | $162.43     |
| 2025-03 | 668          | $808.28       | $98.47  | $709.81     |
| 2025-02 | 700          | $486.12       | $94.36  | $391.76     |
| 2025-01 | 794          | $484.69       | $104.25 | $380.43     |
| 2024-12 | 1022         | $723.28       | $137.69 | $585.59     |
| 2024-11 | 1162         | $1038.43      | $189.38 | $849.05     |
| 2024-10 | 296          | $91.65        | $26.57  | $65.09      |
| 2024-09 | 269          | $73.84        | $21.76  | $52.08      |
| 2024-08 | 390          | $193.18       | $44.98  | $148.20     |
| 2024-07 | 389          | $139.89       | $36.40  | $103.49     |
| 2024-06 | 278          | $107.51       | $28.68  | $78.82      |
| 2024-05 | 319          | $115.56       | $31.22  | $84.33      |
| 2024-04 | 588          | $361.88       | $80.81  | $281.08     |
| 2024-03 | 1000         | $581.21       | $138.51 | $442.70     |
| 2024-02 | 586          | $283.51       | $72.40  | $211.11     |
| 2024-01 | 587          | $648.50       | $109.96 | $538.54     |

    11416

$7169.14
$1464.71
$5704.42

利润反而不高

### 改为盈利阈值完全由 `n * 0.2%` 决定

6246.784480

| Month   | Transactions | Gross Revenue | Fees    | Net Revenue |
| ------- | ------------ | ------------- | ------- | ----------- |
| 2025-09 | 61           | $24.17        | $5.95   | $18.22      |
| 2025-08 | 448          | $273.73       | $49.17  | $224.57     |
| 2025-07 | 451          | $233.68       | $47.14  | $186.54     |
| 2025-06 | 270          | $105.75       | $24.27  | $81.48      |
| 2025-05 | 433          | $195.55       | $44.58  | $150.98     |
| 2025-04 | 366          | $183.39       | $35.86  | $147.53     |
| 2025-03 | 594          | $867.06       | $86.51  | $780.55     |
| 2025-02 | 552          | $434.39       | $69.07  | $365.31     |
| 2025-01 | 653          | $461.82       | $81.96  | $379.86     |
| 2024-12 | 854          | $743.61       | $111.34 | $632.26     |
| 2024-11 | 907          | $957.82       | $136.46 | $821.36     |
| 2024-10 | 255          | $87.50        | $22.88  | $64.62      |
| 2024-09 | 253          | $79.61        | $20.34  | $59.27      |
| 2024-08 | 311          | $175.21       | $33.07  | $142.14     |
| 2024-07 | 320          | $133.67       | $29.60  | $104.07     |
| 2024-06 | 260          | $112.21       | $26.12  | $86.09      |
| 2024-05 | 288          | $109.05       | $27.47  | $81.59      |
| 2024-04 | 497          | $343.44       | $65.74  | $277.70     |
| 2024-03 | 819          | $529.66       | $106.26 | $423.41     |
| 2024-02 | 533          | $283.65       | $65.32  | $218.33     |
| 2024-01 | 524          | $642.29       | $99.50  | $542.79     |

    9649

$6977.29
$1188.62
$5788.67

### n \* 0.14%

6304.773230

| Month   | Transactions | Gross Revenue | Fees    | Net Revenue |
| ------- | ------------ | ------------- | ------- | ----------- |
| 2025-09 | 87           | $22.56        | $5.90   | $16.66      |
| 2025-08 | 631          | $259.38       | $57.32  | $202.05     |
| 2025-07 | 655          | $241.34       | $57.47  | $183.87     |
| 2025-06 | 410          | $107.39       | $29.29  | $78.09      |
| 2025-05 | 669          | $192.87       | $54.82  | $138.05     |
| 2025-04 | 555          | $197.16       | $44.75  | $152.41     |
| 2025-03 | 839          | $849.73       | $102.45 | $747.29     |
| 2025-02 | 840          | $487.24       | $92.42  | $394.81     |
| 2025-01 | 965          | $469.93       | $101.03 | $368.89     |
| 2024-12 | 1154         | $707.82       | $127.88 | $579.95     |
| 2024-11 | 1439         | $1056.61      | $187.83 | $868.78     |
| 2024-10 | 359          | $90.65        | $26.08  | $64.56      |
| 2024-09 | 337          | $77.38        | $22.45  | $54.93      |
| 2024-08 | 501          | $189.32       | $43.58  | $145.75     |
| 2024-07 | 501          | $139.38       | $38.87  | $100.51     |
| 2024-06 | 329          | $102.26       | $28.08  | $74.19      |
| 2024-05 | 418          | $119.83       | $33.57  | $86.26      |
| 2024-04 | 712          | $350.38       | $78.58  | $271.80     |
| 2024-03 | 1185         | $564.67       | $132.75 | $431.92     |
| 2024-02 | 764          | $306.42       | $77.81  | $228.62     |
| 2024-01 | 713          | $657.24       | $114.22 | $543.02     |

    14063

$7189.57
$1457.15
$5732.42

1. 只有一天是负收益,无空档天数.
2. 交易笔数多, 手续费多, 返还划算

### BUY SELL 使用一样的入场策虑;

交易数量大幅减少, 但是每个月收益都比之前的要差一些, 我都不想继续测试完毕了

6404.217630

| Month   | Transactions | Gross Revenue | Fees    | Net Revenue |
| ------- | ------------ | ------------- | ------- | ----------- |
| 2024-12 | 605          | $459.59       | $66.95  | $392.64     |
| 2024-11 | 1394         | $1024.50      | $154.92 | $869.58     |
| 2024-10 | 97           | $69.90        | $8.29   | $61.61      |
| 2024-09 | 93           | $74.95        | $7.90   | $67.05      |
| 2024-08 | 151          | $157.42       | $15.35  | $142.07     |
| 2024-07 | 150          | $114.53       | $13.57  | $100.96     |
| 2024-06 | 104          | $92.38        | $11.98  | $80.40      |
| 2024-05 | 141          | $99.35        | $12.76  | $86.59      |
| 2024-04 | 388          | $325.77       | $44.51  | $281.26     |
| 2024-03 | 1152         | $524.28       | $109.36 | $414.92     |
| 2024-02 | 802          | $276.31       | $63.82  | $212.50     |
| 2024-01 | 696          | $632.57       | $90.59  | $541.98     |

    5848

$3879.75
$605.99
$3273.76

### BUY 及时入场, 有下跌就挂单了 0.14; 0.4

看来及时入场收益是最高的, 反正投入金额基于变化百分比, 这是恒定的

月收入取得了突破

6454.372020

| Month   | Transactions | Gross Revenue | Fees    | Net Revenue |
| ------- | ------------ | ------------- | ------- | ----------- |
| 2024-11 | 3139         | $1034.83      | $162.19 | $872.64     |
| 2024-10 | 494          | $77.37        | $11.00  | $66.37      |
| 2024-09 | 473          | $69.78        | $9.86   | $59.92      |
| 2024-08 | 674          | $159.67       | $18.99  | $140.68     |
| 2024-07 | 736          | $127.92       | $19.01  | $108.91     |
| 2024-06 | 491          | $96.05        | $14.39  | $81.66      |
| 2024-05 | 647          | $99.44        | $15.65  | $83.79      |
| 2024-04 | 1363         | $331.89       | $49.48  | $282.41     |
| 2024-03 | 3219         | $567.78       | $119.30 | $448.48     |
| 2024-02 | 2318         | $304.26       | $70.95  | $233.31     |
| 2024-01 | 1595         | $643.09       | $93.70  | $549.39     |

买入太多, 太慢了, 不等运行完毕了

    16272

$3871.24
$638.59
$3232.65

收益稍稍多一点, 所以还是直接买得了

### 0.24; 2.44

bd9b2ee4

保底 2.44%

似乎区别不大, 中间的一些波动被放弃了

| Month   | Transactions | Gross Revenue | Fees   | Net Revenue |
| ------- | ------------ | ------------- | ------ | ----------- |
| 2024-04 | 568          | $275.07       | $24.90 | $250.17     |
| 2024-03 | 1118         | $466.17       | $48.62 | $417.55     |
| 2024-02 | 749          | $269.60       | $28.24 | $241.36     |
| 2024-01 | 633          | $594.64       | $51.23 | $543.41     |

交易笔数少了很多

### 0.1; 0.4; 及时 SELL 和 BUY

小波动也吃, 大的也可以吃到

6560.995550

| Month   | Transactions | Gross Revenue | Fees    | Net Revenue |
| ------- | ------------ | ------------- | ------- | ----------- |
| 2025-09 | 260          | $18.82        | $4.93   | $13.89      |
| 2025-08 | 2194         | $258.69       | $63.00  | $195.69     |
| 2025-07 | 2002         | $234.07       | $57.59  | $176.47     |
| 2025-06 | 1250         | $100.23       | $25.11  | $75.12      |
| 2025-05 | 1901         | $190.59       | $49.38  | $141.22     |
| 2025-04 | 1639         | $189.28       | $39.52  | $149.76     |
| 2025-03 | 2510         | $802.46       | $106.10 | $696.36     |
| 2025-02 | 2673         | $461.36       | $89.23  | $372.13     |
| 2025-01 | 3447         | $462.32       | $113.79 | $348.53     |
| 2024-12 | 3853         | $739.15       | $158.06 | $581.09     |
| 2024-11 | 4089         | $1071.95      | $231.28 | $840.67     |
| 2024-10 | 922          | $77.05        | $18.12  | $58.94      |
| 2024-09 | 919          | $74.19        | $17.09  | $57.10      |
| 2024-08 | 1334         | $179.07       | $33.29  | $145.78     |
| 2024-07 | 1409         | $136.74       | $33.16  | $103.59     |
| 2024-06 | 946          | $98.58        | $23.53  | $75.05      |
| 2024-05 | 1317         | $114.09       | $28.68  | $85.41      |
| 2024-04 | 2373         | $347.89       | $80.04  | $268.85     |
| 2024-03 | 4135         | $590.80       | $161.37 | $429.42     |
| 2024-02 | 2877         | $305.55       | $91.29  | $214.25     |
| 2024-01 | 2044         | $654.81       | $115.43 | $539.38     |

    44108

$7108.21
$1540.16
$5568.05

如果考虑手续费能返接近一半的话, 这个策略最好. 收益能达到 6000 多了

### 测试更长的检测周期 5m 15m 30m

#### 5m

6146.155470

| Month   | Transactions | Gross Revenue | Fees    | Net Revenue |
| ------- | ------------ | ------------- | ------- | ----------- |
| 2025-09 | 147          | $27.84        | $4.70   | $23.14      |
| 2025-08 | 830          | $267.90       | $45.41  | $222.50     |
| 2025-07 | 738          | $227.01       | $39.11  | $187.90     |
| 2025-06 | 521          | $94.32        | $17.91  | $76.41      |
| 2025-05 | 769          | $179.19       | $33.96  | $145.23     |
| 2025-04 | 636          | $185.40       | $27.03  | $158.37     |
| 2025-03 | 856          | $715.29       | $58.77  | $656.52     |
| 2025-02 | 879          | $454.61       | $63.47  | $391.14     |
| 2025-01 | 1091         | $470.96       | $76.88  | $394.08     |
| 2024-12 | 1182         | $634.93       | $103.75 | $531.18     |
| 2024-11 | 1157         | $981.90       | $123.93 | $857.97     |
| 2024-10 | 463          | $78.58        | $14.64  | $63.94      |
| 2024-09 | 447          | $72.87        | $12.63  | $60.24      |
| 2024-08 | 532          | $162.04       | $24.08  | $137.97     |
| 2024-07 | 593          | $145.13       | $25.57  | $119.56     |
| 2024-06 | 475          | $83.68        | $16.23  | $67.45      |
| 2024-05 | 554          | $99.98        | $18.80  | $81.19      |
| 2024-04 | 899          | $299.48       | $52.73  | $246.75     |
| 2024-03 | 1282         | $465.55       | $92.42  | $373.13     |
| 2024-02 | 1101         | $290.01       | $59.46  | $230.55     |
| 2024-01 | 1006         | $569.29       | $88.45  | $480.85     |

    16158

$6505.97
$999.90
$5506.07

#### 15m

5965.778730

| Month   | Transactions | Gross Revenue | Fees   | Net Revenue |
| ------- | ------------ | ------------- | ------ | ----------- |
| 2025-09 | 87           | $24.36        | $3.82  | $20.54      |
| 2025-08 | 352          | $250.61       | $29.47 | $221.14     |
| 2025-07 | 351          | $206.46       | $27.97 | $178.49     |
| 2025-06 | 281          | $96.38        | $15.53 | $80.85      |
| 2025-05 | 381          | $172.62       | $27.60 | $145.02     |
| 2025-04 | 317          | $196.67       | $21.32 | $175.35     |
| 2025-03 | 402          | $1046.02      | $43.74 | $1002.28    |
| 2025-02 | 390          | $515.40       | $47.70 | $467.70     |
| 2025-01 | 470          | $445.02       | $48.48 | $396.54     |
| 2024-12 | 451          | $597.41       | $72.37 | $525.04     |
| 2024-11 | 476          | $832.12       | $70.75 | $761.37     |
| 2024-10 | 253          | $60.79        | $10.80 | $49.99      |
| 2024-09 | 250          | $72.39        | $10.47 | $61.91      |
| 2024-08 | 304          | $175.97       | $19.69 | $156.27     |
| 2024-07 | 330          | $141.33       | $19.69 | $121.65     |
| 2024-06 | 252          | $89.35        | $13.76 | $75.59      |
| 2024-05 | 314          | $91.65        | $13.88 | $77.77      |
| 2024-04 | 429          | $344.12       | $45.80 | $298.32     |
| 2024-03 | 507          | $429.94       | $58.05 | $371.90     |
| 2024-02 | 468          | $204.30       | $38.80 | $165.50     |
| 2024-01 | 486          | $565.78       | $70.12 | $495.66     |

    7551

$6558.70
$709.81
$5848.89

#### 30m

6115.877380

| Month   | Transactions | Gross Revenue | Fees   | Net Revenue |
| ------- | ------------ | ------------- | ------ | ----------- |
| 2025-09 | 43           | $18.45        | $2.83  | $15.62      |
| 2025-08 | 215          | $281.80       | $26.26 | $255.53     |
| 2025-07 | 213          | $189.24       | $19.80 | $169.44     |
| 2025-06 | 177          | $95.95        | $13.14 | $82.81      |
| 2025-05 | 210          | $150.75       | $21.83 | $128.92     |
| 2025-04 | 188          | $186.86       | $17.02 | $169.84     |
| 2025-03 | 213          | $1074.85      | $45.01 | $1029.84    |
| 2025-02 | 222          | $276.46       | $30.68 | $245.77     |
| 2025-01 | 246          | $489.40       | $39.81 | $449.59     |
| 2024-12 | 251          | $586.94       | $52.27 | $534.68     |
| 2024-11 | 236          | $920.33       | $50.78 | $869.55     |
| 2024-10 | 152          | $66.00        | $10.51 | $55.49      |
| 2024-09 | 161          | $66.34        | $8.06  | $58.27      |
| 2024-08 | 176          | $166.31       | $15.31 | $150.99     |
| 2024-07 | 184          | $172.61       | $19.99 | $152.62     |
| 2024-06 | 151          | $67.04        | $10.15 | $56.89      |
| 2024-05 | 171          | $92.20        | $11.03 | $81.18      |
| 2024-04 | 228          | $278.33       | $32.93 | $245.40     |
| 2024-03 | 258          | $356.09       | $40.31 | $315.78     |
| 2024-02 | 236          | $208.71       | $27.12 | $181.58     |
| 2024-01 | 293          | $450.19       | $55.72 | $394.47     |

    4224

$6194.84
$550.58
$5644.26

#### 1h

5802.053040

| Month   | Transactions | Gross Revenue | Fees   | Net Revenue |
| ------- | ------------ | ------------- | ------ | ----------- |
| 2025-09 | 21           | $16.70        | $2.13  | $14.57      |
| 2025-08 | 119          | $340.06       | $24.46 | $315.60     |
| 2025-07 | 125          | $172.43       | $15.33 | $157.09     |
| 2025-06 | 104          | $94.03        | $9.80  | $84.23      |
| 2025-05 | 131          | $141.95       | $15.64 | $126.31     |
| 2025-04 | 113          | $207.21       | $17.33 | $189.88     |
| 2025-03 | 129          | $1232.98      | $35.40 | $1197.59    |
| 2025-02 | 115          | $325.14       | $21.08 | $304.05     |
| 2025-01 | 141          | $486.87       | $33.67 | $453.20     |
| 2024-12 | 145          | $513.74       | $37.08 | $476.66     |
| 2024-11 | 128          | $1045.40      | $35.05 | $1010.35    |
| 2024-10 | 99           | $65.99        | $9.57  | $56.42      |
| 2024-09 | 100          | $73.36        | $7.08  | $66.28      |
| 2024-08 | 120          | $182.39       | $18.31 | $164.09     |
| 2024-07 | 113          | $162.40       | $13.12 | $149.28     |
| 2024-06 | 104          | $80.08        | $10.07 | $70.01      |
| 2024-05 | 106          | $108.05       | $10.86 | $97.19      |
| 2024-04 | 138          | $346.60       | $33.67 | $312.93     |
| 2024-03 | 143          | $347.52       | $32.37 | $315.15     |
| 2024-02 | 123          | $263.86       | $23.43 | $240.42     |
| 2024-01 | 147          | $368.52       | $35.09 | $333.43     |

    2464

$6575.29
$440.56
$6134.74

#### 4h

5980.528490

| Month   | Transactions | Gross Revenue | Fees   | Net Revenue |
| ------- | ------------ | ------------- | ------ | ----------- |
| 2025-09 | 7            | $10.06        | $1.63  | $8.43       |
| 2025-08 | 44           | $271.14       | $13.77 | $257.37     |
| 2025-07 | 29           | $432.14       | $11.49 | $420.64     |
| 2025-06 | 26           | $52.64        | $6.93  | $45.71      |
| 2025-05 | 42           | $193.54       | $10.88 | $182.66     |
| 2025-04 | 39           | $191.23       | $8.67  | $182.56     |
| 2025-03 | 37           | $1182.57      | $19.37 | $1163.20    |
| 2025-02 | 30           | $322.85       | $16.65 | $306.20     |
| 2025-01 | 35           | $621.27       | $21.41 | $599.86     |
| 2024-12 | 37           | $290.67       | $13.60 | $277.07     |
| 2024-11 | 35           | $1276.39      | $18.47 | $1257.92    |
| 2024-10 | 36           | $51.47        | $5.70  | $45.77      |
| 2024-09 | 29           | $72.21        | $3.38  | $68.83      |
| 2024-08 | 36           | $69.67        | $5.24  | $64.43      |
| 2024-07 | 30           | $173.28       | $9.34  | $163.95     |
| 2024-06 | 35           | $55.68        | $5.88  | $49.80      |
| 2024-05 | 39           | $60.25        | $4.91  | $55.34      |
| 2024-04 | 31           | $87.41        | $9.73  | $77.69      |
| 2024-03 | 44           | $149.24       | $11.58 | $137.66     |
| 2024-02 | 35           | $243.22       | $11.24 | $231.98     |
| 2024-01 | 27           | $285.11       | $14.97 | $270.15     |

    703

$6092.05
$224.83
$5867.22

#### 1h 4 demark

    1602

$6483.33
$383.60
$6099.74

#### 1h 12 demark

    270

$5866.62
$160.48
$5706.14

#### 1h 1 demark 14.44 利润要求

    227

$6958.14
$62.90
$6895.24

#### 1h 1 demark 24.44 利润要求

119
$7426.55
$45.94
$7380.61

演变成了大部分时间dca抄底, 暴涨时候卖出的策略

#### 1h 1 demark 34.44 利润要求

亏

#### 1h 1 demark 8.44 利润要求

    388

$6305.89
$84.37
$6221.52

#### 1h 1 demark 1.44 利润要求

    1542

$6409.49
$271.95
$6137.55

#### 1h 4 demark 1.44 利润要求

    1472

$6158.08
$245.96
$5912.12

长期持有并没有比频繁交易有更多的利润, 如果未出现大额上涨, 那么完全错失了小范围波动带来的利润

回归1m

### demark 参与卖出限制

0.44 的利润保证, 导致了大量快速卖出

#### 1m; 0.1; 0.44; demark SELL 4; demark BUY 1

6584.575540

| Month   | Transactions | Gross Revenue | Fees    | Net Revenue |
| ------- | ------------ | ------------- | ------- | ----------- |
| 2025-02 | 2473         | $450.32       | $81.99  | $368.32     |
| 2025-01 | 3234         | $460.54       | $107.13 | $353.42     |
| 2024-12 | 3614         | $726.94       | $148.94 | $577.99     |
| 2024-11 | 3878         | $1053.50      | $215.64 | $837.86     |
| 2024-10 | 848          | $77.20        | $17.15  | $60.04      |
| 2024-09 | 837          | $73.59        | $16.05  | $57.54      |
| 2024-08 | 1246         | $176.35       | $31.19  | $145.17     |
| 2024-07 | 1285         | $134.36       | $29.78  | $104.58     |
| 2024-06 | 844          | $98.66        | $21.95  | $76.72      |
| 2024-05 | 1182         | $108.65       | $25.67  | $82.99      |
| 2024-04 | 2233         | $355.26       | $76.28  | $278.98     |

每个月都不如别设置 demark 的记录

### SELL k 线 index 修改

#### 1h -2 index

    2183

$6921.71
$374.06
$6547.64

收益获得了不小的提升

#### 1h -3 index

    2085

$6693.66
$355.98
$6337.69

#### 1h -4 index

1600
$6144.83
$276.49
$5868.34

#### 1m -2 index
