# v38_real_world

## 缘由

git 1be3f64e 修复了回测中预知下一根k线的错误

这个错误导致保证后两根k线都会上涨, 并且依然以初始低价入场, 剔除了当条k线入场又下跌的窘境.

于是这个预知至少保证覆盖了大部分的手续费

修复后, 欢迎来到真实的残酷交易世界

## 测试最稳定的

```python
def transform_demark_signal(
    side: str,
    value: int,
    unmatched_orders_count: int,
) -> tuple[str, int]:
    """根据业务规则对 DeMark 信号做二次加工 (v36)"""

    if not ENABLE_DEMARK_SECONDARY_SIGNAL_PROCESSING:
        return side, value
    if side == BUY:
        return SELL, value

    # 没进货, 只有头两个允许进货
    # if side == SELL and value <= 2 and unmatched_orders_count < 2:
    # if side == SELL and unmatched_orders_count < 2:  # 没进货, 一律追高买入(escape all)
    # if side == SELL and value <= 14:  # 信号没超过 14 一律追高买, 坚决不卖
    if side == SELL:  # 两者翻转了, 和 demark 信号相反的操作
        return BUY, value

    return side, value
```

翻转 demark 信号, 追高入场, 信号翻转才卖出

| 月份    | 订单数 | 总利润  | 总手续费 | 到手利润 |
| ------- | ------ | ------- | -------- | -------- |
| 2025-05 | 1097   | 60.53   | 1162.66  | -1102.13 |
| 2025-04 | 1784   | 767.19  | 1948.27  | -1181.08 |
| 2025-03 | 1887   | 178.36  | 2046.17  | -1867.81 |
| 2025-02 | 1696   | 390.65  | 1785.55  | -1394.89 |
| 2025-01 | 1890   | 462.58  | 2032.23  | -1569.65 |
| 2024-12 | 1912   | 1056.41 | 2009.03  | -952.63  |
| 2024-11 | 1834   | 1109.40 | 2012.76  | -903.36  |
| 2024-10 | 1831   | 1378.19 | 1985.17  | -606.99  |
| 2024-09 | 1949   | 1393.65 | 2009.94  | -616.29  |
| 2024-08 | 1844   | 1968.21 | 1954.02  | 14.19    |
| 2024-07 | 1806   | 1291.23 | 2001.05  | -709.82  |
| 2024-06 | 1757   | 1115.05 | 1954.63  | -839.59  |
| 2024-05 | 1736   | 1817.47 | 2009.11  | -191.65  |
| 2024-04 | 1568   | 2670.19 | 1777.28  | 892.90   |
| 2024-03 | 1748   | 2683.48 | 1994.02  | 689.46   |
| 2024-02 | 1642   | 2077.14 | 1858.98  | 218.17   |
| 2024-01 | 680    | 1442.44 | 780.30   | 662.13   |

就不测试完毕了, 没有手续费还能考虑下, 至少不看手续费, 每个月还是能盈利的

年景比较好的 2024 年, 算上返佣还能覆盖手续费, 但是 2025 年就难以覆盖了

这个策略如果没有手续费的话, 还是可以继续优化的

## 15m

去掉了翻转, 按 demark BUY 赌翻转来买入

15m 因为减少频率降低了手续费, 能盖手续费, 吃返佣那可能还行

| 月份    | 订单数 | 总利润  | 总手续费 | 到手利润 |
| ------- | ------ | ------- | -------- | -------- |
| 2025-11 | 296    | 35.82   | 337.27   | -301.45  |
| 2025-10 | 814    | 78.69   | 881.49   | -802.80  |
| 2025-09 | 824    | -340.52 | 881.10   | -1221.62 |
| 2025-08 | 826    | 157.39  | 917.57   | -760.18  |
| 2025-07 | 819    | 404.54  | 897.79   | -493.25  |
| 2025-06 | 814    | 169.63  | 963.47   | -793.84  |
| 2025-05 | 878    | 165.21  | 955.80   | -790.59  |
| 2025-04 | 820    | 289.49  | 955.65   | -666.16  |
| 2025-03 | 852    | 528.43  | 970.07   | -441.63  |
| 2025-02 | 735    | 1003.56 | 865.97   | 137.59   |
| 2025-01 | 862    | 114.41  | 991.55   | -877.14  |
| 2024-12 | 870    | -52.17  | 973.48   | -1025.65 |
| 2024-11 | 813    | 1173.50 | 890.56   | 282.94   |
| 2024-10 | 843    | 590.54  | 956.12   | -365.58  |
| 2024-09 | 848    | 910.93  | 932.54   | -21.62   |
| 2024-08 | 875    | 857.26  | 976.61   | -119.35  |
| 2024-07 | 829    | 440.49  | 908.02   | -467.53  |
| 2024-06 | 842    | 412.99  | 940.01   | -527.02  |
| 2024-05 | 914    | 1404.94 | 1057.25  | 347.69   |
| 2024-04 | 834    | 2395.23 | 965.89   | 1429.35  |
| 2024-03 | 900    | 1863.77 | 999.69   | 864.08   |
| 2024-02 | 835    | 1603.14 | 907.17   | 695.97   |
| 2024-01 | 360    | 880.75  | 402.41   | 478.33   |

| 交易对  | 订单数 | 总利润   | 总手续费 | 到手利润 |
| ------- | ------ | -------- | -------- | -------- |
| SUIUSDC | 18303  | 15087.99 | 20527.46 | -5439.47 |

2025 年算上返利也是持续在亏的

## 30m

| 月份    | 订单数 | 总利润  | 总手续费 | 到手利润 |
| ------- | ------ | ------- | -------- | -------- |
| 2025-11 | 176    | -169.83 | 200.56   | -370.39  |
| 2025-10 | 415    | 160.71  | 457.89   | -297.18  |
| 2025-09 | 393    | 139.36  | 433.76   | -294.40  |
| 2025-08 | 434    | 105.99  | 479.91   | -373.91  |
| 2025-07 | 446    | 359.13  | 474.23   | -115.10  |
| 2025-06 | 419    | -77.89  | 451.68   | -529.57  |
| 2025-05 | 433    | 237.74  | 458.06   | -220.31  |
| 2025-04 | 394    | 301.85  | 449.93   | -148.08  |
| 2025-03 | 429    | 188.87  | 483.98   | -295.11  |
| 2025-02 | 400    | 72.40   | 467.69   | -395.29  |
| 2025-01 | 416    | -197.27 | 469.48   | -666.74  |
| 2024-12 | 424    | 10.65   | 475.73   | -465.09  |
| 2024-11 | 430    | 920.09  | 482.70   | 437.39   |
| 2024-10 | 426    | -241.21 | 491.52   | -732.74  |
| 2024-09 | 425    | 519.10  | 454.36   | 64.74    |
| 2024-08 | 442    | 750.31  | 490.65   | 259.67   |
| 2024-07 | 407    | 162.19  | 453.91   | -291.72  |
| 2024-06 | 399    | -170.30 | 445.53   | -615.84  |
| 2024-05 | 434    | 489.39  | 474.36   | 15.04    |
| 2024-04 | 421    | 783.77  | 468.58   | 315.19   |
| 2024-03 | 462    | 1070.81 | 515.03   | 555.79   |
| 2024-02 | 408    | 949.71  | 466.66   | 483.05   |
| 2024-01 | 182    | 840.27  | 195.62   | 644.65   |

| 交易对  | 订单数 | 总利润  | 总手续费 | 到手利润 |
| ------- | ------ | ------- | -------- | -------- |
| SUIUSDC | 9216   | 7205.84 | 10241.80 | -3035.95 |

## 翻转追高 if side == SELL and value <= 4 and unmatched_orders_count < 2:

| 月份    | 订单数 | 总利润  | 总手续费 | 到手利润 |
| ------- | ------ | ------- | -------- | -------- |
| 2025-01 | 442    | 177.50  | 442.04   | -264.54  |
| 2024-12 | 748    | 607.99  | 739.79   | -131.79  |
| 2024-11 | 712    | 143.39  | 715.21   | -571.82  |
| 2024-10 | 701    | 173.98  | 735.19   | -561.21  |
| 2024-09 | 718    | 461.02  | 707.66   | -246.64  |
| 2024-08 | 765    | 486.39  | 755.91   | -269.52  |
| 2024-07 | 779    | 248.07  | 787.71   | -539.64  |
| 2024-06 | 751    | 284.05  | 725.66   | -441.62  |
| 2024-05 | 793    | 588.47  | 778.13   | -189.66  |
| 2024-04 | 727    | 1522.26 | 750.70   | 771.56   |
| 2024-03 | 758    | 1095.39 | 772.41   | 322.97   |
| 2024-02 | 742    | 1027.00 | 734.30   | 292.69   |
| 2024-01 | 313    | 606.87  | 310.00   | 296.88   |

### 2-4

```python
    if side == BUY and value < 2: ## 第一个 BUY 归到 尽快跑路

    if side == SELL and value < 4: ## 1,2,3 前3个追高入场, 避免没上车
```

虚假的结果:

| 月份    | 订单数 | 总利润  | 总手续费 | 到手利润 |
| ------- | ------ | ------- | -------- | -------- |
| 2025-11 | 257    | 585.02  | 319.61   | 265.41   |
| 2025-10 | 743    | 1631.42 | 926.56   | 704.86   |
| 2025-09 | 697    | 1047.27 | 865.77   | 181.50   |
| 2025-08 | 741    | 1126.66 | 949.99   | 176.68   |
| 2025-07 | 739    | 1715.60 | 936.59   | 779.01   |
| 2025-06 | 749    | 1124.88 | 954.06   | 170.83   |
| 2025-05 | 795    | 1937.04 | 977.06   | 959.98   |
| 2025-04 | 748    | 1554.71 | 948.50   | 606.21   |
| 2025-03 | 750    | 1763.40 | 938.75   | 824.65   |
| 2025-02 | 685    | 2448.78 | 875.10   | 1573.68  |
| 2025-01 | 778    | 1714.44 | 980.68   | 733.76   |
| 2024-12 | 772    | 2751.99 | 971.73   | 1780.26  |
| 2024-11 | 718    | 2434.27 | 917.24   | 1517.03  |
| 2024-10 | 729    | 2377.14 | 931.27   | 1445.87  |
| 2024-09 | 723    | 2956.33 | 905.89   | 2050.44  |
| 2024-08 | 750    | 2801.53 | 923.89   | 1877.64  |
| 2024-07 | 748    | 1841.30 | 950.87   | 890.43   |
| 2024-06 | 760    | 1718.84 | 928.85   | 789.99   |
| 2024-05 | 772    | 2524.59 | 945.69   | 1578.89  |
| 2024-04 | 735    | 4367.39 | 935.32   | 3432.07  |
| 2024-03 | 751    | 3913.42 | 964.90   | 2948.51  |
| 2024-02 | 694    | 3138.98 | 869.93   | 2269.05  |
| 2024-01 | 290    | 2165.20 | 357.35   | 1807.86  |

| 交易对  | 订单数 | 总利润   | 总手续费 | 到手利润 |
| ------- | ------ | -------- | -------- | -------- |
| SUIUSDC | 16124  | 49640.20 | 20275.59 | 29364.62 |

真实的结果:

| 月份    | 订单数 | 总利润  | 总手续费 | 到手利润 |
| ------- | ------ | ------- | -------- | -------- |
| 2025-11 | 289    | -114.78 | 373.02   | -487.80  |
| 2025-10 | 827    | 624.54  | 1007.91  | -383.37  |
| 2025-09 | 797    | 103.76  | 989.22   | -885.46  |
| 2025-08 | 815    | 53.77   | 1025.23  | -971.46  |
| 2025-07 | 813    | 494.52  | 1025.65  | -531.13  |
| 2025-06 | 860    | -111.79 | 1067.29  | -1179.09 |
| 2025-05 | 887    | 610.69  | 1096.09  | -485.39  |
| 2025-04 | 831    | 24.74   | 1039.32  | -1014.58 |
| 2025-03 | 857    | 102.80  | 1053.54  | -950.74  |
| 2025-02 | 751    | 1049.87 | 961.95   | 87.92    |
| 2025-01 | 860    | 265.88  | 1079.55  | -813.68  |
| 2024-12 | 851    | 838.76  | 1066.12  | -227.36  |
| 2024-11 | 789    | 552.58  | 999.64   | -447.07  |
| 2024-10 | 791    | 644.70  | 1005.79  | -361.09  |
| 2024-09 | 788    | 1353.35 | 964.58   | 388.77   |
| 2024-08 | 844    | 724.81  | 1014.23  | -289.42  |
| 2024-07 | 830    | 653.06  | 1038.04  | -384.98  |
| 2024-06 | 833    | 477.62  | 1037.88  | -560.26  |
| 2024-05 | 868    | 1212.14 | 1102.71  | 109.43   |
| 2024-04 | 796    | 2852.12 | 1020.04  | 1832.08  |
| 2024-03 | 800    | 1907.48 | 1013.11  | 894.37   |
| 2024-02 | 770    | 1767.64 | 974.84   | 792.79   |
| 2024-01 | 332    | 1091.13 | 418.43   | 672.69   |

| 交易对  | 订单数 | 总利润   | 总手续费 | 到手利润 |
| ------- | ------ | -------- | -------- | -------- |
| SUIUSDC | 17879  | 17179.36 | 22374.19 | -5194.84 |

可能这个算是最好的一个了, 如果算上返佣, 是比较挣的

### 2-4 入场了尽快跑路

`if side == SELL and value < 4 and unmatched_orders_count < 2:`

尽快设置止损, 区别也不大

| 月份    | 订单数 | 总利润  | 总手续费 | 到手利润 |
| ------- | ------ | ------- | -------- | -------- |
| 2024-12 | 672    | 95.38   | 778.78   | -683.40  |
| 2024-11 | 965    | 666.06  | 1106.62  | -440.56  |
| 2024-10 | 980    | 518.42  | 1144.57  | -626.15  |
| 2024-09 | 998    | 917.07  | 1133.13  | -216.06  |
| 2024-08 | 1037   | 702.42  | 1171.13  | -468.70  |
| 2024-07 | 1011   | 611.06  | 1170.88  | -559.81  |
| 2024-06 | 1030   | 301.13  | 1180.65  | -879.52  |
| 2024-05 | 1123   | 1461.34 | 1282.21  | 179.13   |
| 2024-04 | 1012   | 3184.51 | 1173.42  | 2011.09  |
| 2024-03 | 1090   | 1586.90 | 1230.18  | 356.73   |
| 2024-02 | 1020   | 1926.10 | 1176.18  | 749.92   |
| 2024-01 | 439    | 1067.29 | 502.91   | 564.38   |

### 4 入场了尽快跑路

    if side == SELL and value < 4 and unmatched_orders_count < 2:

| 月份    | 订单数 | 总利润  | 总手续费 | 到手利润 |
| ------- | ------ | ------- | -------- | -------- |
| 2024-10 | 544    | 150.29  | 566.50   | -416.21  |
| 2024-09 | 658    | 312.44  | 651.24   | -338.80  |
| 2024-08 | 694    | 492.89  | 679.61   | -186.72  |
| 2024-07 | 706    | 304.46  | 735.41   | -430.95  |
| 2024-06 | 688    | 243.79  | 665.34   | -421.55  |
| 2024-05 | 727    | 603.60  | 753.79   | -150.19  |
| 2024-04 | 656    | 1458.46 | 706.29   | 752.17   |
| 2024-03 | 691    | 1063.72 | 736.04   | 327.68   |
| 2024-02 | 676    | 1000.64 | 669.98   | 330.66   |
| 2024-01 | 282    | 602.30  | 289.84   | 312.46   |

### 4 头两个允许追高

| 月份    | 订单数 | 总利润  | 总手续费 | 到手利润 |
| ------- | ------ | ------- | -------- | -------- |
| 2025-01 | 280    | 33.93   | 225.30   | -191.36  |
| 2024-12 | 678    | 313.49  | 619.27   | -305.79  |
| 2024-11 | 611    | 152.82  | 542.90   | -390.07  |
| 2024-10 | 606    | 252.34  | 570.96   | -318.62  |
| 2024-09 | 612    | 212.83  | 539.04   | -326.21  |
| 2024-08 | 657    | 557.96  | 547.65   | 10.31    |
| 2024-07 | 668    | 255.09  | 639.28   | -384.19  |
| 2024-06 | 650    | 248.14  | 561.28   | -313.14  |
| 2024-05 | 680    | 516.59  | 605.65   | -89.05   |
| 2024-04 | 609    | 1401.33 | 590.13   | 811.21   |
| 2024-03 | 643    | 907.12  | 607.79   | 299.33   |
| 2024-02 | 621    | 829.00  | 553.66   | 275.34   |
| 2024-01 | 257    | 594.70  | 229.78   | 364.92   |

### 4 追高中间入场

    if side == SELL and 4 < value < 7 and unmatched_orders_count < 2:

| 月份    | 订单数 | 总利润 | 总手续费 | 到手利润 |
| ------- | ------ | ------ | -------- | -------- |
| 2024-07 | 229    | -91.43 | 165.03   | -256.46  |
| 2024-06 | 217    | -14.45 | 188.99   | -203.44  |
| 2024-05 | 205    | 127.46 | 157.11   | -29.65   |
| 2024-04 | 193    | 149.82 | 125.10   | 24.72    |
| 2024-03 | 211    | 331.96 | 165.33   | 166.63   |
| 2024-02 | 202    | 185.41 | 177.11   | 8.29     |
| 2024-01 | 83     | -3.94  | 52.41    | -56.35   |

### 测试难度较高的入场

    if side == BUY and value < 9:

L
