# v21

## 需求

在 get_optimized_from_price 计算 from_price 的时候, 如果没有被套住的价格, 就会使用 klines_price, 并在来源里面注明.

我希望 \_calculate_raw_qty 在计算 entry_amount 的时候, 如果价格来源是 klines_price, 那么说明当前没有被套住的金额, 那么 entry_amount 要变为原本的10倍.

否则, 就要查出现在被套住资金的最高的价格是多少, 与当前价格相比较, 价格差异百分比越大, 那么投入资金也就越少, 按原本规则计算出来的 entry_amount 对应变少.

这个功能需要在 feature_flags.py 添加一个常量开关, 来决定是否开启.

• 可以改成用比例剩余的平方来缩放:

- 定义跌幅 drop = clamp((highest_unmatched_price - price) / highest_unmatched_price, 0, 1)
- 计算缩放系数 scaling = (1 - drop) \*\* 2

这样:

- 跌幅 0% → (1 - 0)^2 = 1,不缩减
- 跌幅 20% → (0.8)^2 = 0.64,缩到 64%
- 跌幅 50% → (0.5)^2 = 0.25,正好是四分之一

该公式单调递减,跌幅越大资金越少,且不会出现负值.

## 原始 0.4%

小波动也吃, 大的也可以吃到

6561.995550

| Month   | Transactions | Gross Revenue | Fees    | Net Revenue |
| ------- | ------------ | ------------- | ------- | ----------- |
| 2025-09 | 260          | $18.82        | $4.93   | $13.89      |
| 2025-08 | 2194         | $258.69       | $63.00  | $195.69     |
| 2025-07 | 2002         | $234.07       | $57.59  | $176.47     |
| 2025-06 | 1250         | $100.23       | $25.11  | $75.12      |
| 2025-05 | 1901         | $190.59       | $49.38  | $141.22     |
| 2025-04 | 1639         | $189.28       | $39.52  | $149.76     |
| 2025-03 | 2510         | $802.46       | $106.10 | $696.36     |
| 2025-02 | 2673         | $461.36       | $89.23  | $372.13     |
| 2025-01 | 3447         | $462.32       | $113.79 | $348.53     |
| 2024-12 | 3853         | $739.15       | $158.06 | $581.09     |
| 2024-11 | 4089         | $1071.95      | $231.28 | $840.67     |
| 2024-10 | 922          | $77.05        | $18.12  | $58.94      |
| 2024-09 | 919          | $74.19        | $17.09  | $57.10      |
| 2024-08 | 1334         | $179.07       | $33.29  | $145.78     |
| 2024-07 | 1409         | $136.74       | $33.16  | $103.59     |
| 2024-06 | 946          | $98.58        | $23.53  | $75.05      |
| 2024-05 | 1317         | $114.09       | $28.68  | $85.41      |
| 2024-04 | 2373         | $347.89       | $80.04  | $268.85     |
| 2024-03 | 4135         | $590.80       | $161.37 | $429.42     |
| 2024-02 | 2877         | $305.55       | $91.29  | $214.25     |
| 2024-01 | 2044         | $654.81       | $115.43 | $539.38     |

    44108

$7108.21
$1540.16
$5568.05

## 0.44, 10

```python
    if ADAPTIVE_ENTRY_AMOUNT_ENABLED and side == BUY:
        if from_price_source == FromPriceSource.KLINES:
            entry_amount = entry_amount * Decimal("10")
        else:
            highest_unmatched_price: Decimal | None = None
            for order in unmatched_orders:
                price_decimal = Decimal(order.average_price)
                if (
                    highest_unmatched_price is None
                    or price_decimal > highest_unmatched_price
                ):
                    highest_unmatched_price = price_decimal

            if highest_unmatched_price and highest_unmatched_price > 0:
                drop = (highest_unmatched_price - price) / highest_unmatched_price
                if drop <= 0:
                    scaling_factor = Decimal("1")
                elif drop >= Decimal("1"):
                    scaling_factor = Decimal("0")
                else:
                    remaining = Decimal("1") - drop
                    scaling_factor = remaining * remaining

                entry_amount = entry_amount * scaling_factor
```

1m 新最大值: 1904.411750 USDC (之前: 0.000000), 本地时间: 2024-01-01 16:26:00 CST
1m 新最大值: 3601.137740 USDC (之前: 3499.214540), 本地时间: 2024-04-14 05:15:00 CST
1m 新最大值: 3926.083370 USDC (之前: 3923.281210), 本地时间: 2024-08-05 21:18:00 CST
1m 新最大值: 4342.170940 USDC (之前: 4339.087840), 本地时间: 2025-06-23 04:15:00 CST

| Month   | Transactions | Gross Revenue | Fees    | Net Revenue |
| ------- | ------------ | ------------- | ------- | ----------- |
| 2025-09 | 174          | $8.11         | $1.94   | $6.17       |
| 2025-08 | 1497         | $112.37       | $25.39  | $86.98      |
| 2025-07 | 1278         | $81.45        | $18.44  | $63.00      |
| 2025-06 | 524          | $21.08        | $4.71   | $16.37      |
| 2025-05 | 1189         | $64.22        | $15.32  | $48.90      |
| 2025-04 | 823          | $44.34        | $8.29   | $36.05      |
| 2025-03 | 1688         | $348.87       | $44.47  | $304.41     |
| 2025-02 | 1696         | $134.00       | $25.43  | $108.57     |
| 2025-01 | 2727         | $265.91       | $61.71  | $204.21     |
| 2024-12 | 3218         | $702.09       | $143.65 | $558.44     |
| 2024-11 | 3551         | $967.11       | $194.21 | $772.90     |
| 2024-10 | 362          | $14.69        | $2.80   | $11.88      |
| 2024-09 | 339          | $13.80        | $2.63   | $11.18      |
| 2024-08 | 526          | $28.67        | $4.77   | $23.91      |
| 2024-07 | 700          | $32.79        | $6.89   | $25.90      |
| 2024-06 | 473          | $25.85        | $5.54   | $20.31      |
| 2024-05 | 752          | $34.66        | $8.06   | $26.60      |
| 2024-04 | 1678         | $129.28       | $28.98  | $100.30     |
| 2024-03 | 3716         | $516.31       | $135.04 | $381.27     |
| 2024-02 | 2515         | $304.33       | $84.75  | $219.57     |
| 2024-01 | 1717         | $600.65       | $89.97  | $510.68     |

    31143

$4450.59
$912.98
$3537.62

## 调整下跌幅度

```
• - 缩放表:
      - 0% → 100.00
      - 5% → 88.22
      - 10% → 77.68
      - 15% → 68.31
      - 20% → 60.00
      - 25% → 52.67
      - 30% → 46.24
      - 35% → 40.60
      - 40% → 35.68
      - 45% → 31.39
      - 50% → 27.63
      - 55% → 24.32
      - 60% → 21.37
      - 65% → 18.68
      - 70% → 16.18
      - 75% → 13.77
      - 80% → 11.37
      - 85% → 8.87
      - 90% → 6.21
      - 95% → 3.28
      - 100% → 0.00
```

## 调整

```python
    if ADAPTIVE_ENTRY_AMOUNT_ENABLED:
        if from_price_source == FromPriceSource.KLINES:
            entry_amount = entry_amount * Decimal("2")
        else:
            highest_unmatched_price = _get_highest_unmatched_price(unmatched_orders)
            if highest_unmatched_price is None:
                raise ValueError("缺少未匹配订单成本价")
            # drop 表示当前价格相对最高未匹配成本价的跌幅比例; 跌幅越大, 后续资金投入越需要收紧
            drop = (highest_unmatched_price - price) / highest_unmatched_price
            if drop <= 0:
                scaling_factor = Decimal("1")
            elif drop >= Decimal("1"):
                scaling_factor = Decimal("0")
            else:
                # 使用二次与三次项的多项式系数构造平滑衰减曲线: 初期快速缩减, 深跌阶段逐步趋缓
                drop_square = drop * drop
                drop_cube = drop_square * drop
                scaling_factor = (
                    Decimal("1")
                    + Decimal("-2.4868") * drop
                    + Decimal("2.6708") * drop_square
                    + Decimal("-1.184") * drop_cube
                )
                if scaling_factor < 0:
                    scaling_factor = Decimal("0")

            entry_amount = entry_amount * scaling_factor
```

1m 新最大值: 3186.246640 USDC (之前: 3176.168510), 本地时间: 2024-07-05 16:48:00 CST
1m 新最大值: 3287.917780 USDC (之前: 3226.000580), 本地时间: 2024-08-05 14:26:00 CST
1m 新最大值: 3288.952270 USDC (之前: 3288.773080), 本地时间: 2025-06-23 04:15:00 CST

| Month   | Transactions | Gross Revenue | Fees    | Net Revenue |
| ------- | ------------ | ------------- | ------- | ----------- |
| 2025-09 | 174          | $7.91         | $1.89   | $6.02       |
| 2025-08 | 1489         | $108.18       | $24.40  | $83.79      |
| 2025-07 | 1294         | $81.98        | $18.48  | $63.51      |
| 2025-06 | 581          | $24.73        | $5.61   | $19.12      |
| 2025-05 | 1198         | $64.89        | $15.44  | $49.44      |
| 2025-04 | 864          | $50.22        | $9.41   | $40.81      |
| 2025-03 | 1701         | $339.25       | $43.26  | $295.99     |
| 2025-02 | 1701         | $139.89       | $26.00  | $113.88     |
| 2025-01 | 2667         | $249.46       | $57.79  | $191.68     |
| 2024-12 | 3186         | $482.84       | $101.13 | $381.71     |
| 2024-11 | 3556         | $735.43       | $152.97 | $582.46     |
| 2024-10 | 437          | $18.14        | $3.79   | $14.35      |
| 2024-09 | 408          | $17.20        | $3.56   | $13.64      |
| 2024-08 | 650          | $37.69        | $6.62   | $31.07      |
| 2024-07 | 748          | $36.68        | $7.81   | $28.87      |
| 2024-06 | 499          | $28.55        | $6.22   | $22.33      |
| 2024-05 | 761          | $35.35        | $8.23   | $27.12      |
| 2024-04 | 1671         | $128.29       | $28.44  | $99.85      |
| 2024-03 | 3678         | $431.46       | $113.45 | $318.01     |
| 2024-02 | 2568         | $255.30       | $72.00  | $183.30     |
| 2024-01 | 1775         | $473.23       | $77.28  | $395.95     |

    31606

$3746.67
$783.78
$2962.89

套住资金少了, 但是低位的时候, 那几个月等于是废的, 一个月收益不到 20$ 都出来了. 和停了区别不大.
